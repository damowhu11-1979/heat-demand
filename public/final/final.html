<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Final Calculation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link rel="stylesheet" href="css/print.css" media="print" />
  
  <style>
    /* New Fix: Apply border-box globally for predictable width calculation */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    .brand { height:48px; max-width:280px; object-fit:contain }

    :root { --rail: 260px; --g: 14px; --card: #f7f7f7; --ink:#111; --muted:#666; --line:#e5e7eb; --accent:#10b981; }
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:#fff;
      /* FIX 1: Prevent global horizontal scrolling caused by overflowing content */
      overflow-x: hidden;
    }

    /* Layout: fixed rail so nothing can cover it */
    .wrap{min-height:100vh;}
    .rail{
      position:fixed;            
      left:0; top:0; bottom:0;
      width:var(--rail);
      background:#fafafa;
      border-right:1px solid var(--line);
      padding:24px 18px;
      z-index:2147483647;
      overflow-y: auto;
    }
    .main{
      margin-left:var(--rail);   /* make room for fixed rail */
      padding:28px 34px;
      
      /* FIX 2: Explicitly constrain the main content area to the remaining viewport width */
      max-width: calc(100vw - var(--rail));
    }

    .logo{font-weight:800; letter-spacing:6px; font-size:28px}
    .navTitle{margin:16px 0 12px; color:#7a7a7a; font-weight:600;}

    .step{
      display:flex;
      align-items:center;
      justify-content:space-between;
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 12px;
      margin-bottom:8px;
      background:#fff;
      transition: background 0.1s;
      pointer-events: auto;
      cursor: pointer;
    }
    
    .nav-link:hover .step {
      background: #f0f0f0;
      border-color: #ccc;
    }

    .nav-link{
      text-decoration:none;
      color:inherit;
      display:block;
      cursor: pointer; 
      pointer-events: auto;
    }

    .tick{
      width: 18px; 
      height: 18px; 
      min-width: 18px; 
      border-radius: 999px; 
      background: var(--accent); 
      margin-left: 10px; 
    }

    .topline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:2px solid #111;
      padding-bottom:12px;
      margin-bottom:16px;
    }
    .title{margin:0; font-size:34px; letter-spacing:.4px}
    .meta{font-size:12px; color:var(--muted)}

    .kpis{display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:16px; margin:16px 0 24px;}
    .kpi{background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px 16px;}
    .kpi h4{margin:0 0 6px; font-size:13px; color:#444; font-weight:600; letter-spacing:.3px;}
    .kpi .big{font-size:36px; font-weight:800}
    .kpi .unit{font-weight:600; margin-left:6px; color:#444}
    .kpi .sub{margin-top:6px; color:#666; font-size:12px}
    
    /* New styles for the summary card and loading state */
    #summaryCard {
        grid-column: 1 / -1; /* Make the card span full width */
        padding: 20px;
    }
    .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--accent);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .summary-text {
        margin-top: 15px;
        line-height: 1.6;
        background: #fcfcfc;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #eee;
    }
    .citation-list {
        font-size: 10px;
        color: #888;
        margin-top: 10px;
        list-style-type: none;
        padding-left: 0;
    }
    .citation-list a {
        color: #555;
        text-decoration: none;
    }


    .h2{font-size:22px; margin:24px 0 8px}
    .cardGrid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    .card{background:#fff; border:1px solid var(--line); border-radius:12px; padding:16px;}
    .card h5{margin:0 0 6px; font-size:13px; color:#444}
    .card .big{font-size:30px; font-weight:800}
    .hr{margin:14px 0 8px; border-top:2px solid #111}

    /* Table styles for display */
    table{width:100%; border-collapse:separate; border-spacing:0; background:#fff; border:1px solid var(--line); border-radius:12px; overflow:hidden;}
    th,td{padding:12px 14px; border-top:1px solid var(--line); vertical-align:middle;}
    th{background:#fafafa; text-align:left; font-weight:700; color:#333;}
    tr:first-child th, tr:first-child td{border-top:0}
    td.num{text-align:right; font-variant-numeric: tabular-nums}
    tfoot td{font-weight:700; background:#fbfbfb}

    /* New CSS class for responsive tables */
    .table-responsive {
        overflow-x: auto; /* Allows horizontal scrolling when content overflows */
        margin-bottom: 24px; 
    }

    .notice{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid var(--line); background:#f8fffB;
      border-left:5px solid var(--accent); padding:12px 14px;
      border-radius:8px; color:#1b4332; font-size:13px;
    }

    @media print {
      .rail{display:none}
      .main{margin:0; padding:20px}
      .topline{border-bottom:1px solid #000}
      .kpi{page-break-inside:avoid}
      .card, table{page-break-inside:avoid}
      /* Ensure everything is visible in print */
      body { background: white; }
      
      /* New rule: Hide logo change/reset buttons on print */
      #btnLogoPick, #btnLogoReset {
          display: none !important;
      }
      /* Ensure tables don't scroll in print mode */
      .table-responsive {
        overflow-x: visible; 
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <aside class="rail">
      <div class="logo">M C S</div>
      <div class="navTitle">Heat Load Calculator</div>

      <!-- Links are now clean, root-relative paths for Vercel compatibility -->
      <a class="nav-link" href="/">
        <div class="step">Property Information <span class="tick"></span></div>
      </a>
      <a class="nav-link" href="/ventilation">
        <div class="step">Ventilation <span class="tick"></span></div>
      </a>
      <a class="nav-link" href="/rooms">
        <div class="step">Heated Rooms <span class="tick"></span></div>
      </a>
      <a class="nav-link" href="/room-elements">
        <div class="step">Building Elements <span class="tick"></span></div>
      </a>
      <a class="nav-link" href="/final">
        <div class="step">Result Calculation <span class="tick"></span></div>
      </a>
    </aside>

    <main class="main">
      <div class="topline">
        <div>
          <h1 class="title">Final Calculation</h1>
          <div class="meta" id="metaDate"></div>
        </div>

        <div style="display:flex; align-items:center; gap:8px">
          <img id="brandLogo" src="https://placehold.co/120x48/10b981/ffffff?text=Company+Logo" class="brand" alt="Company logo" />
          <input id="logoFile" type="file" accept="image/png,image/jpeg,image/svg+xml" style="display:none" />
          <button id="btnLogoPick" type="button">Change logo</button>
          <button id="btnLogoReset" type="button" title="Revert to default">Reset</button>
        </div>
      </div>

      <div class="notice">
        <div style="font-size:18px;line-height:1">✓</div>
        <div>
          <strong>This calculation is MIS&nbsp;3005-D compliant for designing heat pumps.</strong>
          <div style="color:#4a5568"></div>
        </div>
      </div>

      <section class="kpis">
        <div class="kpi">
          <h4>Peak Heat Load</h4>
          <div><span id="kpiPeak" class="big">10.5</span><span class="unit">kWp</span></div>
          <div class="sub">The system size required to meet the space heating load.</div>
        </div>
        <div class="kpi">
          <h4>Heat Load By Floor Area</h4>
          <div><span id="kpiWm2" class="big">55.8</span><span class="unit">W/m²</span></div>
          <div class="sub">Whole-house load normalised by floor area.</div>
        </div>
        <div class="kpi">
          <h4>Annual Heating Energy Estimate</h4>
          <div><span id="kpiKwh" class="big">12,500</span><span class="unit">kWh/yr</span></div>
          <div class="sub">Actual energy depends on system efficiency (e.g., SCoP).</div>
        </div>
        
        <!-- NEW GEMINI FEATURE CARD -->
        <div id="summaryCard" class="card">
            <h3 style="margin:0 0 10px; font-size:16px;">Client Communication Tool (Gemini AI)</h3>
            <div style="display:flex; align-items:center;">
                <button id="btnGenerateSummary" type="button" style="padding: 8px 15px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Generate Client Summary ✨
                </button>
                <div id="summaryLoader" style="display:none; margin-left: 15px; align-items: center;">
                    <div class="loading-spinner"></div>
                    <span style="font-size:12px; color:#555;">Generating summary...</span>
                </div>
            </div>
            <div id="summaryOutput">
                <!-- Summary Text and Citations will appear here -->
            </div>
        </div>
        <!-- END NEW GEMINI FEATURE CARD -->
        
      </section>

      <h2 class="h2">Design Conditions</h2>
      <div class="cardGrid">
        <div class="card"><h5>Average Internal Room Temperature</h5><div><span id="dcAvgInt" class="big">20</span> <span class="unit">°C</span></div></div>
        <div class="card"><h5>Mean Annual External Air Temperature</h5><div><span id="dcAvgExt" class="big">9.5</span> <span class="unit">°C</span></div></div>
        <div class="card"><h5>Design External Air Temperature</h5><div><span id="dcDesignExt" class="big">-3</span> <span class="unit">°C</span></div></div>
        <div class="card"><h5>Heating Degree Days</h5><div><span id="dcHdd" class="big">2400</span></div></div>
      </div>

      <div class="hr"></div>
      <h2 class="h2">Calculation Details</h2>
      <div class="cardGrid">
        <div class="card"><h5>Fabric Heat Loss</h5><div><span id="cdFabric" class="big">–</span> <span class="unit">W</span></div></div>
        <div class="card"><h5>Ventilation Heat Loss</h5><div><span id="cdVent" class="big">–</span> <span class="unit">W</span></div></div>
        <div class="card"><h5>Heating Up Power</h5><div><span id="cdHeatUp" class="big">–</span> <span class="unit">W</span></div></div>
        <div class="card"><h5>Heat Gains</h5><div><span id="cdGains" class="big">0</span> <span class="unit">W</span></div></div>
        <div class="card" style="grid-column:1/-1"><h5>Space Heating Load</h5><div><span id="cdSpaceLoad" class="big">–</span> <span class="unit">W</span></div></div>
      </div>

      <div class="hr"></div>
      <h2 class="h2">Per-Room Peak Heat Loss</h2>
      <!-- Responsive Wrapper -->
      <div class="table-responsive">
        <table id="perRoomTbl">
          <thead><tr><th>Room Name</th><th>Floor Area (m²)</th><th>Design Temp (°C)</th><th>Peak Heat Load (W)</th><th>By Floor Area (W/m²)</th><th>Annual Energy (kWh/yr)</th></tr></thead>
          <tbody id="perRoomBody"></tbody>
        </table>
      </div>
      <!-- End Responsive Wrapper -->

      <div class="hr"></div>
      <h2 class="h2">Fabric Breakdown</h2>
      <!-- Responsive Wrapper -->
      <div class="table-responsive">
        <table id="fabricTbl">
          <thead><tr><th>Adjacent Space</th><th>Description</th><th>Adjacent Temp (°C)</th><th class="num">Fabric Heat Loss (W)</th><th class="num">%</th></tr></thead>
          <tbody id="fabricBody"></tbody>
        </table>
      </div>
      <!-- End Responsive Wrapper -->

      <div class="hr"></div>
      <h2 class="h2">Ventilation Breakdown</h2>
      <!-- Responsive Wrapper -->
      <div class="table-responsive">
        <table id="ventTbl">
          <thead><tr><th>Zone Name</th><th>Internal Air Volume (m³)</th><th>External Surface Area† (m²)</th><th>Air Permeability @ 50Pa†† (m³/m²·h)</th><th class="num">Ventilation Heat Loss (W)</th><th class="num">%</th></tr></thead>
          <tbody id="ventBody"></tbody>
        </table>
      </div>
      <!-- End Responsive Wrapper -->

      <p class="meta" style="margin-top:10px">
        † External surface area excludes party walls (BS 12831-1:2017).
        †† Permeability may differ to measured airtightness due to dimension options.
      </p>

      <div style="margin:16px 0 6px">
        <button id="btnPrint" onclick="window.print()">Download PDF</button>
      </div>
      <div class="meta">
        Floors to ground use ΔT against annual average external temperature (MIS 3005-D).
      </div>
    </main>
  </div>

  <!-- Your original logic -->
  <script type="module" src="js/final.js"></script>
  <script type="module" src="js/skin-mcs.js"></script>

  <!-- GEMINI AI INTEGRATION -->
  <script type="module">
    const summaryButton = document.getElementById('btnGenerateSummary');
    const summaryOutput = document.getElementById('summaryOutput');
    const summaryLoader = document.getElementById('summaryLoader');

    summaryButton.addEventListener('click', generateClientSummary);

    // Exponential backoff retry logic
    async function fetchWithRetry(url, options, retries = 5) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, options);
          if (!response.ok) {
            if (response.status === 429 && i < retries - 1) { // Too Many Requests
              const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
              await new Promise(resolve => setTimeout(resolve, delay));
              continue;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response;
        } catch (error) {
          if (i === retries - 1) {
            throw error;
          }
          const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }
    
    // Function to safely extract text content from an element, or return a fallback
    function safeRead(id, fallback = 'Unknown') {
        const el = document.getElementById(id);
        if (el) {
            // Remove unit text (like kWp, kWh/yr) and strip whitespace
            return el.textContent.replace(/[^0-9.,-]+/g, '').trim() || fallback;
        }
        return fallback;
    }

    async function generateClientSummary() {
        summaryButton.disabled = true;
        summaryLoader.style.display = 'flex';
        summaryOutput.innerHTML = ''; // Clear previous results

        try {
            // 1. Collect data from the KPI cards
            const peakLoad = safeRead('kpiPeak', '10.5'); // Default used for demonstration if final.js hasn't run
            const annualEnergy = safeRead('kpiKwh', '12500');
            const designTemp = safeRead('dcDesignExt', '-3');

            const systemPrompt = "Act as a professional, friendly, and non-technical energy consultant. Write a concise, single-paragraph summary of the heat load calculation results for a homeowner. Clearly state the required heat pump size (kWp), the estimated annual energy usage (kWh/yr), and mention that the calculation adheres to the UK's MIS 3005-D standard. Use encouraging and simple language. Do NOT use markdown headings or lists.";
            
            const userQuery = `Based on the following calculated values for a property: Peak Heat Load: ${peakLoad} kWp, Annual Heating Energy Estimate: ${annualEnergy} kWh/yr, Design External Temperature: ${designTemp}°C. Provide a client-facing explanation.`;

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                let sourcesHtml = '';
                
                // Extract and format grounding sources
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);

                    if (sources.length > 0) {
                        sourcesHtml = `<ul class="citation-list">Grounding Sources: ${sources.map(s => `<li><a href="${s.uri}" target="_blank">${s.title}</a></li>`).join('')}</ul>`;
                    }
                }

                summaryOutput.innerHTML = `
                    <div class="summary-text">${text.replace(/\n/g, '<br>')}</div>
                    ${sourcesHtml}
                `;
            } else {
                summaryOutput.innerHTML = `<p style="color:red;">Error: Could not generate summary. Please check the API response.</p>`;
            }

        } catch (error) {
            console.error('Gemini API Error:', error);
            summaryOutput.innerHTML = `<p style="color:red;">An error occurred while connecting to the AI service. (${error.message})</p>`;
        } finally {
            summaryButton.disabled = false;
            summaryLoader.style.display = 'none';
        }
    }
  </script>
</body>
</html>
