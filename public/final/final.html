<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Final Calculation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link rel="stylesheet" href="css/print.css" media="print" />
  
  <style>
    /* New Fix: Apply border-box globally for predictable width calculation */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    .brand { height:48px; max-width:280px; object-fit:contain }

    :root { --rail: 260px; --g: 14px; --card: #f7f7f7; --ink:#111; --muted:#666; --line:#e5e7eb; --accent:#10b981; }
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:#fff;
      /* FIX 1: Prevent global horizontal scrolling caused by overflowing content */
      overflow-x: hidden;
    }

    /* Layout: fixed rail so nothing can cover it */
    .wrap{min-height:100vh;}
    .rail{
      position:fixed;            
      left:0; top:0; bottom:0;
      width:var(--rail);
      background:#fafafa;
      border-right:1px solid var(--line);
      padding:24px 18px;
      z-index:2147483647;
      overflow-y: auto;
    }
    .main{
      margin-left:var(--rail);   /* make room for fixed rail */
      padding:28px 34px;
      
      /* FIX 2: Explicitly constrain the main content area to the remaining viewport width */
      max-width: calc(100vw - var(--rail));
    }

    .logo{font-weight:800; letter-spacing:6px; font-size:28px}
    .navTitle{margin:16px 0 12px; color:#7a7a7a; font-weight:600;}

    .step{
      display:flex;
      align-items:center;
      justify-content:space-between;
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 12px;
      margin-bottom:8px;
      background:#fff;
      transition: background 0.1s;
      pointer-events: auto;
      cursor: pointer;
    }
    
    .nav-link:hover .step {
      background: #f0f0f0;
      border-color: #ccc;
    }

    .nav-link{
      text-decoration:none;
      color:inherit;
      display:block;
      cursor: pointer; 
      pointer-events: auto;
    }

    .tick{
      width: 18px; 
      height: 18px; 
      min-width: 18px; 
      border-radius: 999px; 
      background: var(--accent); 
      margin-left: 10px; 
    }

    .topline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:2px solid #111;
      padding-bottom:12px;
      margin-bottom:16px;
    }
    .title{margin:0; font-size:34px; letter-spacing:.4px}
    .meta{font-size:12px; color:var(--muted)}

    .kpis{display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:16px; margin:16px 0 24px;}
    .kpi{background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px 16px;}
    .kpi h4{margin:0 0 6px; font-size:13px; color:#444; font-weight:600; letter-spacing:.3px;}
    .kpi .big{font-size:36px; font-weight:800}
    .kpi .unit{font-weight:600; margin-left:6px; color:#444}
    .kpi .sub{margin-top:6px; color:#666; font-size:12px}
    
    /* New styles for the summary card and loading state */
    #summaryCard {
        grid-column: 1 / -1; /* Make the card span full width */
        padding: 20px;
    }
    .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--accent);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .summary-text {
        margin-top: 15px;
        line-height: 1.6;
        background: #fcfcfc;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #eee;
    }
    .citation-list {
        font-size: 10px;
        color: #888;
        margin-top: 10px;
        list-style-type: none;
        padding-left: 0;
    }
    .citation-list a {
        color: #555;
        text-decoration: none;
    }


    .h2{font-size:22px; margin:24px 0 8px}
    .cardGrid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    .card{background:#fff; border:1px solid var(--line); border-radius:12px; padding:16px;}
    .card h5{margin:0 0 6px; font-size:13px; color:#444}
    .card .big{font-size:30px; font-weight:800}
    .hr{margin:14px 0 8px; border-top:2px solid #111}

    /* Table styles for display */
    table{width:100%; border-collapse:separate; border-spacing:0; background:#fff; border:1px solid var(--line); border-radius:12px; overflow:hidden;}
    th,td{padding:12px 14px; border-top:1px solid var(--line); vertical-align:middle;}
    th{background:#fafafa; text-align:left; font-weight:700; color:#333;}
    tr:first-child th, tr:first-child td{border-top:0}
    td.num{text-align:right; font-variant-numeric: tabular-nums}
    tfoot td{font-weight:700; background:#fbfbfb}

    /* New CSS class for responsive tables */
    .table-responsive {
        overflow-x: auto; /* Allows horizontal scrolling when content overflows */
        margin-bottom: 24px; 
    }

    .notice{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid var(--line); background:#f8fffB;
      border-left:5px solid var(--accent); padding:12px 14px;
      border-radius:8px; color:#1b4332; font-size:13px;
    }

    @media print {
      .rail{display:none}
      .main{margin:0; padding:20px}
      .topline{border-bottom:1px solid #000}
      .kpi{page-break-inside:avoid}
      .card, table{page-break-inside:avoid}
      /* Ensure everything is visible in print */
      body { background: white; }
      
      /* New rule: Hide logo change/reset buttons on print */
      #btnLogoPick, #btnLogoReset {
          display: none !important;
      }
      /* Ensure tables don't scroll in print mode */
      .table-responsive {
        overflow-x: visible; 
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <aside class="rail">
      <div class="logo">M C S</div>
      <div class="navTitle">Heat Load Calculator</div>

      <!-- Links are now clean, root-relative paths for Vercel compatibility -->
      <a class="nav-link" href="/">
        <div class="step">Property Information <span class="tick"></span></div>
      </a>
      <a class="nav-link" href="/ventilation">
        <div class="step">Ventilation <span class="tick"></span></div>
      </a>
      <a class="nav-link" href="/rooms">
        <div class="step">Heated Rooms <span class="tick"></span></div>
      </a>
      <a class="nav-link" href="/room-elements">
        <div class="step">Building Elements <span class="tick"></span></div>
      </a>
      <a class="nav-link" href="/final">
        <div class="step">Result Calculation <span class="tick"></span></div>
      </a>
    </aside>

    <main class="main">
      <div class="topline">
        <div>
          <h1 class="title">Final Calculation</h1>
          <!-- Replaced static text with an ID for dynamic update from the merged script -->
          <div class="meta" id="projectMeta">Loading project details...</div> 
          <div class="meta" id="method">MIS3005‑D/EN12831‑1:2017</div>
        </div>

        <div style="display:flex; align-items:center; gap:8px">
          <img id="brandLogo" src="https://placehold.co/120x48/10b981/ffffff?text=Company+Logo" class="brand" alt="Company logo" />
          <input id="logoFile" type="file" accept="image/png,image/jpeg,image/svg+xml" style="display:none" />
          <button id="btnLogoPick" type="button">Change logo</button>
          <button id="btnLogoReset" type="button" title="Revert to default">Reset</button>
        </div>
      </div>

      <div class="notice">
        <div style="font-size:18px;line-height:1">✓</div>
        <div>
          <strong>This calculation is MIS&nbsp;3005-D compliant for designing heat pumps.</strong>
          <div style="color:#4a5568"></div>
        </div>
      </div>

      <section class="kpis">
        <div class="kpi">
          <h4>Peak Heat Load</h4>
          <div><span id="peakKW" class="big">–</span><span class="unit">kWp</span></div>
          <div class="sub">The system size required to meet the space heating load.</div>
        </div>
        <div class="kpi">
          <h4>Heat Load By Floor Area</h4>
          <div><span id="wPerM2" class="big">–</span><span class="unit">W/m²</span></div>
          <div class="sub">Whole-house load normalised by floor area.</div>
        </div>
        <div class="kpi">
          <h4>Annual Heating Energy Estimate</h4>
          <div><span id="annualKWh" class="big">–</span><span class="unit">kWh/yr</span></div>
          <div class="sub">Actual energy depends on system efficiency (e.g., SCoP).</div>
        </div>
        
        <!-- NEW GEMINI FEATURE CARD -->
        <div id="summaryCard" class="card">
            <h3 style="margin:0 0 10px; font-size:16px;">Client Communication Tool (Gemini AI)</h3>
            <div style="display:flex; align-items:center;">
                <button id="btnGenerateSummary" type="button" style="padding: 8px 15px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Generate Client Summary ✨
                </button>
                <div id="summaryLoader" style="display:none; margin-left: 15px; align-items: center;">
                    <div class="loading-spinner"></div>
                    <span style="font-size:12px; color:#555;">Generating summary...</span>
                </div>
            </div>
            <div id="summaryOutput">
                <!-- Summary Text and Citations will appear here -->
            </div>
        </div>
        <!-- END NEW GEMINI FEATURE CARD -->
        
      </section>

      <h2 class="h2">Design Conditions</h2>
      <div class="cardGrid" id="designConditions">
        <!-- Content will be generated by JS -->
        <div class="card"><h5>Average Internal Room Temperature</h5><div><span class="big">20</span> <span class="unit">°C</span></div></div>
        <div class="card"><h5>Mean Annual External Air Temperature</h5><div><span class="big">9.5</span> <span class="unit">°C</span></div></div>
        <div class="card"><h5>Design External Air Temperature</h5><div><span class="big">-3</span> <span class="unit">°C</span></div></div>
        <div class="card"><h5>Heating Degree Days</h5><div><span class="big">2400</span></div></div>
      </div>

      <div class="hr"></div>
      <h2 class="h2">Calculation Details</h2>
      <div class="cardGrid" id="calcDetails">
        <!-- Content will be generated by JS -->
        <div class="card"><h5>Fabric Heat Loss</h5><div><span class="big">–</span> <span class="unit">W</span></div></div>
        <div class="card"><h5>Ventilation Heat Loss</h5><div><span class="big">–</span> <span class="unit">W</span></div></div>
        <div class="card"><h5>Heating Up Power</h5><div><span class="big">–</span> <span class="unit">W</span></div></div>
        <div class="card"><h5>Heat Gains</h5><div><span class="big">0</span> <span class="unit">W</span></div></div>
        <div class="card" style="grid-column:1/-1"><h5>Space Heating Load</h5><div><span class="big">–</span> <span class="unit">W</span></div></div>
      </div>

      <div class="hr"></div>
      <h2 class="h2">Per-Room Peak Heat Loss</h2>
      <!-- Responsive Wrapper -->
      <div class="table-responsive">
        <table id="roomTable">
          <thead><tr><th>Room Name</th><th>Floor Area (m²)</th><th>Design Temp (°C)</th><th>Fabric W</th><th>Vent W</th><th>Gains W</th><th>Peak W</th><th>% of Total</th></tr></thead>
          <tbody id="perRoomBody"></tbody>
        </table>
      </div>
      <!-- End Responsive Wrapper -->

      <div class="hr"></div>
      <h2 class="h2">Fabric Breakdown (Per Element)</h2>
      <!-- Responsive Wrapper -->
      <div class="table-responsive">
        <table id="fabricTable">
          <thead><tr><th>Room</th><th>Element</th><th>Adjacent</th><th>Area m²</th><th>U</th><th>Ψ×L</th><th>ΔT</th><th>W</th></tr></thead>
          <tbody id="fabricBody"></tbody>
        </table>
      </div>
      <!-- End Responsive Wrapper -->

      <div class="hr"></div>
      <h2 class="h2">Ventilation Breakdown (Per Room)</h2>
      <!-- Responsive Wrapper -->
      <div class="table-responsive">
        <table id="ventTable">
          <thead><tr><th>Room</th><th>Type</th><th>ACH</th><th>Efficiency</th><th>ΔT</th><th>W</th></tr></thead>
          <tbody id="ventBody"></tbody>
        </table>
      </div>
      <!-- End Responsive Wrapper -->

      <p class="meta" style="margin-top:10px">
        Floors to ground use ΔT against annual average external temperature (MIS 3005-D).
      </p>

      <div style="margin:16px 0 6px">
        <button id="btnPrint" type="button">Download PDF</button>
      </div>
      <div class="meta">
        Floors to ground use ΔT against annual average external temperature (MIS 3005-D).
      </div>
    </main>
  </div>

  <!-- MERGED APPLICATION LOGIC -->
  <script type="module">
    // --- UTILITY STUBS AND MOCK DATA (Replaces external utils.js / templates.js) ---

    // Mock data structure to ensure calculation runs successfully in a standalone file
    const MOCK_CALC_DATA = {
        project: { client: "Mr. J. Smith", siteAddress: "123 Test Street", assessor: "AI Assessor", timestamp: Date.now() },
        design: { avgInternalTemp: 20, avgExternalAnnualTemp: 9.5, designExternalTemp: -3, heatingDegreeDays: 2400 },
        house: { floorAreaTotal: 150, infiltrationRateACH: 0.5, mvhr: { isPresent: false } },
        rooms: [
            { id: 'r1', name: 'Living Room', area_m2: 30, volume_m3: 75, designTemp_C: 21, gains_W: 100, elements: [
                { type: 'Wall', adj: 'external', area_m2: 20, U_Wm2K: 0.3, psi_WmK: 0, length_m: 0 },
                { type: 'Window', adj: 'external', area_m2: 3, U_Wm2K: 1.4, psi_WmK: 0, length_m: 0 },
                { type: 'Floor', adj: 'ground', area_m2: 30, U_Wm2K: 0.2, psi_WmK: 0.5, length_m: 20 },
            ] },
            { id: 'r2', name: 'Kitchen', area_m2: 15, volume_m3: 37.5, designTemp_C: 20, gains_W: 50, elements: [
                { type: 'Wall', adj: 'unheated', area_m2: 10, U_Wm2K: 0.5, unheatedTemp_C: 10 },
                { type: 'Ceiling', adj: 'external', area_m2: 15, U_Wm2K: 0.15 },
            ] }
        ],
        heatUpAllowance_pct: 0.15,
        annual_kWh: 12500 // Mock annual energy for KPI card
    };

    // Stub for readData - returns mock data since no storage/utils file is available
    function readData() { return MOCK_CALC_DATA; }

    // Stub for sum - required by final.js (though not used in the provided snippet)
    function sum(arr) { return arr.reduce((acc, val) => acc + val, 0); }

    // Stub for templates (t) object. Generates basic HTML based on use in final.js
    const t = {
        // Generates the content for the Design Conditions (cardGrid)
        design: (design) => `
            <div class="card"><h5>Average Internal Room Temperature</h5><div><span class="big">${design.avgInternalTemp?.toFixed(1)??'–'}</span> <span class="unit">°C</span></div></div>
            <div class="card"><h5>Mean Annual External Air Temperature</h5><div><span class="big">${design.avgExternalAnnualTemp?.toFixed(1)??'–'}</span> <span class="unit">°C</span></div></div>
            <div class="card"><h5>Design External Air Temperature</h5><div><span class="big">${design.designExternalTemp?.toFixed(1)??'–'}</span> <span class="unit">°C</span></div></div>
            <div class="card"><h5>Heating Degree Days</h5><div><span class="big">${design.heatingDegreeDays?.toFixed(0)??'–'}</span></div></div>
        `,
        // Generates the content for the Calculation Details (cardGrid)
        details: ({fabricW_str, ventW_str, heatUp_str, gains_str, netPeak_str}) => `
            <div class="card"><h5>Fabric Heat Loss</h5><div><span class="big">${fabricW_str}</span> <span class="unit">W</span></div></div>
            <div class="card"><h5>Ventilation Heat Loss</h5><div><span class="big">${ventW_str}</span> <span class="unit">W</span></div></div>
            <div class="card"><h5>Heating Up Power (${heatUp_str})</h5><div><span class="big">${netPeak_str}</span> <span class="unit">W</span></div></div>
            <div class="card"><h5>Heat Gains</h5><div><span class="big">${gains_str}</span> <span class="unit">W</span></div></div>
            <div class="card" style="grid-column:1/-1"><h5>Space Heating Load (Net)</h5><div><span class="big">${netPeak_str}</span> <span class="unit">W</span></div></div>
        `,
        // Generates the table content (for room, fabric, vent tables)
        table: (head, rows) => `
            <thead><tr>${head.map(h => `<th>${h}</th>`).join('')}</tr></thead>
            <tbody>${rows.join('\n')}</tbody>
        `
    };

    // --- FORMATTER FUNCTIONS (Taken from/based on skin-mcs.js) ---

    // Primary formatter (from skin-mcs.js)
    function fmt(n, dp=0){ if(n==null||!isFinite(n)) return '–'; const f = Number(n).toFixed(dp); return (+f).toLocaleString(); }
    
    // Formatters required by final.js (reusing fmt)
    const fmtW = (n) => fmt(n, 0);
    const fmtKW = (n) => fmt(n/1000, 1);
    const fmtWm2 = (n) => fmt(n, 1);
    const fmtC = (n) => fmt(n, 1); // Not strictly used in the final.js DOM part, but good practice

    // --- FINAL.JS CONTENT (Calculation Logic) ---

    (function init(){
        const calc = readData();
        if(!calc){ 
            // Update to a friendly UI message instead of relying on a missing DOM element
            document.querySelector('.main').innerHTML = '<h2 class="h2">Calculation Failed</h2><p class="notice" style="border-left-color: #f97316; background:#fffbf5; color:#9a3412;">No calculation data found. Please ensure all previous steps are complete.</p>'; 
            return; 
        }

        // project/meta
        const ts = calc.project?.timestamp ? new Date(calc.project.timestamp).toLocaleDateString() : '';
        document.getElementById('projectMeta').textContent = [calc.project?.client, calc.project?.siteAddress, calc.project?.assessor, ts].filter(Boolean).join(' • ');
        // Set method version (now dynamically updated, though hardcoded in mock)
        document.getElementById('method').textContent = (calc.project && calc.project.methodVersion) || 'MIS3005‑D/EN12831‑1:2017';

        const fabricRows = [];
        const ventRows = [];
        const roomRows = [];
        let totalFabricW = 0, totalVentW = 0, totalGainsW = 0;

        for(const r of (calc.rooms||[])){
            const dT_ext = r.designTemp_C - calc.design.designExternalTemp;
            let roomFabricW = 0, roomVentW = 0, gains = Number(r.gains_W || 0);

            for(const e of (r.elements||[])){
                const dT = (e.adj === 'ground')
                    ? (r.designTemp_C - calc.design.avgExternalAnnualTemp)
                    : (e.adj === 'unheated')
                        ? (r.designTemp_C - (e.unheatedTemp_C ?? calc.design.designExternalTemp))
                        : dT_ext;
                const tb = (e.psi_WmK && e.length_m) ? e.psi_WmK * e.length_m * dT : 0;
                const u = Number(e.U_Wm2K || 0);
                const a = Number(e.area_m2 || 0);
                const w = (u * a * dT) + tb;
                roomFabricW += w;
                fabricRows.push(`<tr><td>${r.name}</td><td>${e.type}</td><td>${e.adj}</td><td>${a?a.toFixed(2):'—'}</td><td>${u?u.toFixed(3):'—'}</td><td>${tb?tb.toFixed(1):'—'}</td><td>${dT.toFixed(1)}</td><td class="num">${w.toFixed(0)}</td></tr>`);
            }

            // ventilation per room
            const achBase = (r.infiltrationACH ?? calc.house?.infiltrationRateACH ?? 0);
            const vol = Number(r.volume_m3 || 0) || 1;
            const mvhr = calc.house?.mvhr;
            const supply_m3ph = (mvhr?.isPresent ? (mvhr.supply_m3ph || 0) : 0);
            const achSupply = supply_m3ph ? (supply_m3ph / vol) : 0; // m3/h divided by m3 = 1/h (ACH)
            const eta = mvhr?.efficiency ?? 0;
            const achEffective = achBase + (achSupply ? (achSupply * (1 - eta)) : 0);
            const roomVent = 0.33 * achEffective * vol * dT_ext;
            roomVentW = roomVent;

            ventRows.push(`<tr><td>${r.name}</td><td>${achBase ? 'Infiltration' : (mvhr?.isPresent?'MVHR':'Vent')}</td><td class="num">${(achEffective).toFixed(2)}</td><td class="num">${eta? (eta*100).toFixed(0)+'%':'—'}</td><td class="num">${dT_ext.toFixed(1)}</td><td class="num">${roomVent.toFixed(0)}</td></tr>`);

            const peak = roomFabricW + roomVentW - gains;
            // NOTE: Per-room annual kWh calculation is missing, using a placeholder for now
            roomRows.push(`<tr><td>${r.name}</td><td class="num">${r.area_m2?.toFixed(1)??'—'}</td><td class="num">${r.designTemp_C?.toFixed(1)??'—'}</td><td class="num">${roomFabricW.toFixed(0)}</td><td class="num">${roomVentW.toFixed(0)}</td><td class="num">${gains.toFixed(0)}</td><td class="num">${peak.toFixed(0)}</td><td class="num" data-room="${r.id}"></td></tr>`);

            totalFabricW += roomFabricW; totalVentW += roomVentW; totalGainsW += gains;
        }

        const heatUpPct = calc.heatUpAllowance_pct ?? 0;
        const netPeakW = totalFabricW + totalVentW - totalGainsW;
        const totalPeakW = netPeakW * (1 + heatUpPct);
        const floorArea = Number(calc.house?.floorAreaTotal || 0) || 1;
        const wPerM2 = totalPeakW / floorArea;

        // Annual (display only, if upstream not present)
        const dT_design = (calc.design.avgInternalTemp - calc.design.designExternalTemp) || 1;
        const UA = totalFabricW / dT_design;
        const annualKWh = calc.annual_kWh ?? (calc.design.heatingDegreeDays ? (calc.design.heatingDegreeDays * 24 * UA / 1000) : null);

        // --- Store calculation results globally for skin-mcs.js to use (optional but safe) ---
        window.finalCalc = {
            peak_kW: totalPeakW / 1000,
            w_per_m2: wPerM2,
            annual_kWh: annualKWh,
            design: calc.design,
            fabric_W: totalFabricW,
            vent_W: totalVentW,
            heatUp_W: totalPeakW - netPeakW,
            gains_W: totalGainsW,
            spaceHeating_W: totalPeakW,
            rooms: calc.rooms.map((r, i) => ({
                ...r,
                peak_W: Number(roomRows[i].match(/<td[^>]*>(\d+)/g).slice(-2)[0].replace(/[^\d]/g, '')), // Hack to get calculated peak W
                annual_kWh: annualKWh / calc.rooms.length // Placeholder, should be calculated per room
            })),
            fabricByAdj: [], // Not implemented in final.js, leaving blank for simplicity
            ventByZone: [],  // Not implemented in final.js, leaving blank for simplicity
        };
        // -------------------------------------------------------------------------------------

        // Summary
        document.getElementById('peakKW').textContent = fmtKW(totalPeakW);
        document.getElementById('wPerM2').textContent = fmtWm2(wPerM2);
        document.getElementById('annualKWh').textContent = annualKWh ? annualKWh.toFixed(0) : '–'; // Removed ' kWh' unit as it's in the HTML span

        // Design & details (Using the template stubs)
        document.getElementById('designConditions').innerHTML = t.design(calc.design);
        document.getElementById('calcDetails').innerHTML = t.details({
            fabricW_str: fmtW(totalFabricW),
            ventW_str: fmtW(totalVentW),
            heatUp_str: (heatUpPct*100).toFixed(0) + '%',
            gains_str: fmtW(totalGainsW),
            netPeak_str: fmtW(totalPeakW)
        });

        // Tables (Using the template stubs)
        const headRoom = ['Room','Area m²','Design °C','Fabric W','Vent W','Gains W','Peak W','% of Total'];
        const headFabric = ['Room','Element','Adjacent','Area m²','U','Ψ×L','ΔT','W'];
        const headVent = ['Room','Type','ACH','Efficiency','ΔT','W'];
        
        // Populate tables using the logic from final.js
        document.getElementById('roomTable').innerHTML = t.table(headRoom, roomRows);
        document.getElementById('fabricTable').innerHTML = t.table(headFabric, fabricRows);
        document.getElementById('ventTable').innerHTML = t.table(headVent, ventRows);

        // compute % of total per room
        document.querySelectorAll('[data-room]').forEach(td =>{
            const w = Number(td.previousElementSibling.textContent); // peak W cell
            td.textContent = totalPeakW ? ((w/totalPeakW)*100).toFixed(1)+'%' : '—';
        });

        // print button
        document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
    })();

    // --- SKIN-MCS.JS CONTENT (DOM Updating and Logo Persistence) ---

    // The functions fmt and ready are already defined/redundant above, only need the IIFE logic

    /* ---- Persistent brand logo (localStorage) ---- */
    (function logoPersistence(){
        const KEY = 'mcs.brand.logoDataUrl';         // where we persist
        const img = document.getElementById('brandLogo');
        const file = document.getElementById('logoFile');
        const pick = document.getElementById('btnLogoPick');
        const reset = document.getElementById('btnLogoReset');

        // 1) Load persisted logo (if any)
        try {
            const saved = localStorage.getItem(KEY);
            // Default image if needed: 'https://placehold.co/120x48/10b981/ffffff?text=Company+Logo'
            if (saved && /^data:image\//.test(saved)) img.src = saved;
        } catch (e) { console.warn("Local storage access denied for logo."); }

        // 2) Pick new logo
        pick?.addEventListener('click', () => file?.click());
        file?.addEventListener('change', () => {
            const f = file.files && file.files[0];
            if (!f) return;

            if (!/^image\/(png|jpeg|svg\+xml)$/.test(f.type)) {
                // Use a modal/UI message instead of alert()
                console.error('Please choose a PNG, JPG, or SVG file.'); return;
            }
            // Size guard (adjust if you want larger)
            if (f.size > 512 * 1024) { // 512 KB
                console.error('Logo is larger than 512 KB. Please use a smaller image.'); return;
            }

            const reader = new FileReader();
            reader.onload = () => {
                const dataUrl = String(reader.result || '');
                if (!/^data:image\//.test(dataUrl)) { console.error('Invalid image.'); return; }
                try { localStorage.setItem(KEY, dataUrl); } catch (e) {
                    console.error('Could not save logo (storage full or blocked). It will display this session only.');
                }
                img.src = dataUrl;
                // Clear the file input to allow re-uploading the same file if desired
                file.value = '';
            };
            reader.readAsDataURL(f);
        });

        // 3) Reset to default
        reset?.addEventListener('click', () => {
            try { localStorage.removeItem(KEY); } catch {}
            img.src = 'https://placehold.co/120x48/10b981/ffffff?text=Company+Logo';
        });
    })();
    
    // --- GEMINI AI INTEGRATION (This is already fully inline and remains below the calculation) ---
    const summaryButton = document.getElementById('btnGenerateSummary');
    const summaryOutput = document.getElementById('summaryOutput');
    const summaryLoader = document.getElementById('summaryLoader');

    summaryButton.addEventListener('click', generateClientSummary);

    // Exponential backoff retry logic
    async function fetchWithRetry(url, options, retries = 5) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, options);
          if (!response.ok) {
            if (response.status === 429 && i < retries - 1) { // Too Many Requests
              const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
              await new Promise(resolve => setTimeout(resolve, delay));
              continue;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response;
        } catch (error) {
          if (i === retries - 1) {
            throw error;
          }
          const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }
    
    // Function to safely extract text content from an element, or return a fallback
    function safeRead(id, fallback = 'Unknown') {
        const el = document.getElementById(id);
        if (el) {
            // Remove unit text (like kWp, kWh/yr) and strip whitespace
            const textContent = el.textContent || '';
            return textContent.replace(/[^0-9.,-]+/g, '').trim() || fallback;
        }
        return fallback;
    }

    async function generateClientSummary() {
        summaryButton.disabled = true;
        summaryLoader.style.display = 'flex';
        summaryOutput.innerHTML = ''; // Clear previous results

        try {
            // 1. Collect data from the KPI cards
            const peakLoad = safeRead('peakKW', '10.5'); // Use the new ID from final.js
            const annualEnergy = safeRead('annualKWh', '12500'); // Use the new ID
            const calcData = readData();
            const designTemp = calcData.design?.designExternalTemp || '-3';

            const systemPrompt = "Act as a professional, friendly, and non-technical energy consultant. Write a concise, single-paragraph summary of the heat load calculation results for a homeowner. Clearly state the required heat pump size (kWp), the estimated annual energy usage (kWh/yr), and mention that the calculation adheres to the UK's MIS 3005-D standard. Use encouraging and simple language. Do NOT use markdown headings or lists.";
            
            const userQuery = `Based on the following calculated values for a property: Peak Heat Load: ${peakLoad} kWp, Annual Heating Energy Estimate: ${annualEnergy} kWh/yr, Design External Temperature: ${designTemp}°C. Provide a client-facing explanation.`;

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                let sourcesHtml = '';
                
                // Extract and format grounding sources
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);

                    if (sources.length > 0) {
                        sourcesHtml = `<ul class="citation-list">Grounding Sources: ${sources.map(s => `<li><a href="${s.uri}" target="_blank">${s.title}</a></li>`).join('')}</ul>`;
                    }
                }

                summaryOutput.innerHTML = `
                    <div class="summary-text">${text.replace(/\n/g, '<br>')}</div>
                    ${sourcesHtml}
                `;
            } else {
                summaryOutput.innerHTML = `<p style="color:red;">Error: Could not generate summary. Please check the API response.</p>`;
            }

        } catch (error) {
            console.error('Gemini API Error:', error);
            summaryOutput.innerHTML = `<p style="color:red;">An error occurred while connecting to the AI service. (${error.message})</p>`;
        } finally {
            summaryButton.disabled = false;
            summaryLoader.style.display = 'none';
        }
    }
  </script>
</body>
</html>
